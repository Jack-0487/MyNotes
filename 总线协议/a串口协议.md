# 基本概念

- 串行和并行：并行是一次可以多位数据，串行一次只能传输一位数据，只有一根数据线（实际工程中串行较多）

- 单工通信和双工通信

  - 单工：只能单向

    ![image-20230410151647087](image-20230410151647087.png)

  - 双工：能双向通信

    - 半双工：不能同时发送和接收

      ![image-20230410151827851](image-20230410151827851.png)

    - 全双工：能同时发送和接收

      ![image-20230410151940408](image-20230410151940408.png)

- 波特率：用于描述uart通信时的通信速度，单位为bps,即每秒钟传送的bit的数量

- 异步和同步：异步收发双方时钟不一样

- ![image-20230410194741523](image-20230410194741523.png)

  

# UART

- 通用异步收发器
- 串行，异步通信总线
- 有两条数据线，可以实现全双工（同时发送接收）的发送和接收
- 常用于主机与辅助设备之间的通信

## UART帧格式

![image-20230410152258655](image-20230410152258655.png)

- 数据位一般为8位
- 校验位检验数据的正确性，校验位只能校验错误，不能修正错误，校验位可有可无，有校验位后速率会变慢
- 停止位可以有1/1.5/2位，必须要是高电平
- 串口不能连续发送字节是为了防止出现累积误差

# RS232/RS485

## RS232

- RS232是用于串行通讯的标准，标准中对连接器的每个引脚加以规定，并对电平做出规定

- 依赖于串口，在软件编程上没有任何区别

- 一般用简化后的接口（9根线），目前一般只使用RXD，TXD和GND三根线

- 串口存在的问题

  - 电气接口不统一

    ![image-20230410190554833](image-20230410190554833.png)

    ![image-20230410191118343](image-20230410191118343.png)

- 该标准规定逻辑1电平为-5~-15V，逻辑0的电平为+5V到+15V，选用该电气标准的目的在于提高抗干扰能力，增大通信距离，其传输距离可达15M

## RS232存在的问题

![image-20230410192644680](image-20230410192644680.png)

## RS485

- 该标准能在远距离条件下以及电子噪声大的环境下有效传输信号；该标准能连接多个收发器，具有多站能力，可以利用单一的RS485接口方便的建立起一个设备网络
- RS485利用差分信号（电压差）进行数据传输，半双工
- ![image-20230410193052810](image-20230410193052810.png)

- ![image-20230410194223736](image-20230410194223736.png)

# I2C

- 串行，半双工
- 用于近距离，低速芯片之间通信
- SDA收发数据，SCL用于双方时钟同步
- 多主机总线，连接在总线上的器件分为主机和从机，主机有权发起和结束一次通信，从机只能被主机呼叫
- 当总线上有多个主机同时启用总线时，总线具备冲突检测和仲裁功能来防止错误的发生
- 每个连接到总线上的器件都有一个唯一的地址，每个主机可以作为从机，同一时刻只能有一个主机，总线上的设备的增加和删除不影响其它器件正常工作
- 发送数据的器件为发送器，接收数据的器件为接收器

## 通信过程

![image-20230410160125905](image-20230410160125905.png)

- I2C第一个字节一定是主机给从机，后续字节由第一个字节最后一位决定
- 起始信号和停止信号一定是主机发送
- ![image-20230410162558097](image-20230410162558097.png)

## 信号

![image-20230410163356429](image-20230410163356429.png)

- 先发送高位

  ![image-20230410164855171](image-20230410164855171.png)

- ![image-20230410165255549](image-20230410165255549.png)

## 典型时序

![image-20230410170502222](image-20230410170502222.png)

![image-20230410170626491](image-20230410170626491.png)

- 第三种情况中中间没有停止信号，防止总线使用权被抢走

#  SPI总线

- 串行外设接口
- 一种高速、串行、全双工、同步通信接口
- 采用主从工作方式，有一个主设备和多个从设备
- SPI至少需要四根线
  - MISO--主设备输入从设备输出
  - MOSI--主设备输出从设备输入
  - SCLK--时钟
  - CS--片选
- ![image-20230410205211130](image-20230410205211130.png)

- ![image-20230410210424427](image-20230410210424427.png)

![image-20230410211952065](image-20230410211952065.png)

# CAN总线

- [CAN通信知识梳理及在Stm32上的应用（HAL库）_冬瓜~的博客-CSDN博客](https://blog.csdn.net/weixin_44793491/article/details/107298426)

## 硬件

![image-20230411093111833](image-20230411093111833.png)

![image-20230411093146880](image-20230411093146880.png)

- 网络两端必须有120Ω的电阻，由于电缆的特性阻抗为120欧姆，加该电阻为了模拟无限远的传输线

### 电平

![image-20230411093409980](image-20230411093409980.png)

## 协议11898

![image-20230410212946752](image-20230410212946752.png)

## 边界条件

- 长度最长40m
- 速率1Mbit/s
- 网络末端要有终端电阻，防止信号反射
- 不超过32个节点，取决于收发器的驱动能力

## 物理构成

![image-20230410213350021](image-20230410213350021.png)

- controler:通常与MCU整合到一起

- transver

  - 低速can收发器

    - 0~125K速率，不需要终端电阻来阻止反射

    - 差分电平

      ![image-20230410213634392](image-20230410213634392.png)

  - 高速can收发器
    - 0~1Mbit/s,需要120Ω终端电阻
    - 差分电平
      - ![image-20230410213801125](image-20230410213801125.png)

- 总线逻辑
  - 逻辑1是隐形，逻辑0是显性
  - 多点同时发送是遵循线与逻辑

## 通讯

- 去中心化，分布式原则
  - 总线空闲时任意节点均可竞争发消息
  - 消息将被广播，由节点自己决定是否过滤
- 事件驱动（类似单片机中断）
- 通信矩阵

## 帧格式

### 数据帧

- 用于主动传输数据

- 格式

  ![image-20230410214726814](image-20230410214726814.png)

  - sof (1 bit):帧起始，发出一个显性位边沿，网络节点以此开始同步
  - id(11 bit)，仲裁段，定义消息的优先级/总线金证力，数字越低优先级越高，标准格式为11位，扩展格式为29位
  - RTR(1 bit)：显性表示数据帧，隐性表示远程帧
  - r(1 bit)：保留位
  - DLC(4 bit)：表示数据场（data field）字节长度
  - crc(16 bit): crc校验，含一位界定符
  - ack(2 bit): 含一位隐形位界定符，由接收方进行确认，收到消息给出一个显性位，没有确认收到消息，发送方监听此位为隐形位就会报错
  - ide（1 bit）:扩展帧标识符（扩展帧可以有29位）
  - EOF(7 bit):结束标志，7bit隐性位
  - ITM(3 bit)：帧间隔，实际不属于帧内区域，必须等待帧间隔才能发送消息

### 遥控帧

- 用于接收单元向具有相同ID的发送单元请求数据的帧
- ![image-20230411094739938](image-20230411094739938.png)

### 错误帧/过载帧/帧间隔

- 都由硬件完成

## 总线仲裁

- 在总线空闲时最先开始发送的节点获得发送权，一旦开始发送不会被其它节点抢占
- 多个节点同时开始发送时个发送节点从仲裁段第一位开始进行仲裁，连续输出显性电平最多的节点可继续发送（显性优先）
- 具有相同ID的数据帧和遥控帧在总线上竞争时，仲裁段的最后一位位显性位的数据帧具有优先权可继续发送
- 标准格式ID与具有相同ID的遥控帧或者扩展格式的数据帧在总线上竞争时，标准格式的RTR位位显性位的具有优先权可继续发送

